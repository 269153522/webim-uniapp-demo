(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/chat"],{"254b":function(t,e,a){"use strict";var n,o=function(){var t=this,e=t.$createElement;t._self._c},r=[];a.d(e,"b",(function(){return o})),a.d(e,"c",(function(){return r})),a.d(e,"a",(function(){return n}))},"7c90":function(t,e,a){"use strict";var n=a("967a"),o=a.n(n);o.a},"80ca":function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n=a("0fac"),o=a("d98b")["default"],r=function(){a.e("comps/swipedelete/swipedelete").then(function(){return resolve(a("1230"))}.bind(null,a)).catch(a.oe)},s={data:function(){return{search_btn:!0,search_chats:!1,show_mask:!1,yourname:"",unReadSpotNum:0,unReadNoticeNum:0,messageNum:0,unReadTotalNotNum:0,arr:[],show_clear:!1,member:"",isIPX:!1,gotop:!1,input_code:""}},components:{swipeDelete:r},props:{},onLoad:function(){var t=this;n.on("em.subscribe",(function(){t.setData({messageNum:getApp().globalData.saveFriendList.length,unReadTotalNotNum:getApp().globalData.saveFriendList.length+getApp().globalData.saveGroupInvitedList.length})})),n.on("em.invite.deleteGroup",(function(){t.listGroups(),t.getRoster(),t.setData({arr:t.getChatList(),messageNum:getApp().globalData.saveFriendList.length})})),n.on("em.unreadspot",(function(e){t.setData({arr:t.getChatList(),unReadSpotNum:getApp().globalData.unReadMessageNum>99?"99+":getApp().globalData.unReadMessageNum})})),n.on("em.invite.joingroup",(function(){t.setData({unReadNoticeNum:getApp().globalData.saveGroupInvitedList.length,unReadTotalNotNum:getApp().globalData.saveFriendList.length+getApp().globalData.saveGroupInvitedList.length})})),n.on("em.contacts.remove",(function(){t.getRoster()})),this.getRoster()},onShow:function(){this.setData({arr:this.getChatList(),unReadSpotNum:getApp().globalData.unReadMessageNum>99?"99+":getApp().globalData.unReadMessageNum,messageNum:getApp().globalData.saveFriendList.length,unReadNoticeNum:getApp().globalData.saveGroupInvitedList.length,unReadTotalNotNum:getApp().globalData.saveFriendList.length+getApp().globalData.saveGroupInvitedList.length}),getApp().globalData.isIPX&&this.setData({isIPX:!0})},methods:{listGroups:function(){var t=this;return o.conn.listGroups({limit:100,success:function(e){wx.setStorage({key:"listGroup",data:e.data}),t.getChatList()},error:function(t){console.log(t)}})},getRoster:function(){var t=this,e={success:function(e){for(var a=[],o=0;o<e.length;o++)"both"==e[o].subscription&&a.push(e[o]);wx.setStorage({key:"member",data:a}),t.setData({member:a}),t.listGroups(),n.fire("em.main.ready"),t.setData({arr:t.getChatList(),unReadSpotNum:getApp().globalData.unReadMessageNum>99?"99+":getApp().globalData.unReadMessageNum})},error:function(t){console.log(t)}};o.conn.getRoster(e)},getChatList:function(){for(var t=[],e=wx.getStorageSync("member"),a=wx.getStorageSync("myUsername"),n=wx.getStorageSync("listGroup")||[],o=0;o<e.length;o++){var r=wx.getStorageSync(e[o].name+a)||[],s=wx.getStorageSync("rendered_"+e[o].name+a)||[],u=s.concat(r);if(u.length){var i=u[u.length-1];i.unReadCount=r.length,i.unReadCount>99&&(i.unReadCount="99+");var c=i.time.split(" ")[0].split("-"),g=i.time.split(" ")[1].split(":"),l=c[2]<10?"0"+c[2]:c[2];i.dateTimeNum="".concat(c[1]).concat(l).concat(g[0]).concat(g[1]).concat(g[2]),i.time="".concat(c[1],"月").concat(c[2],"日 ").concat(g[0],"时").concat(g[1],"分"),t.push(i)}}for(var m=0;m<n.length;m++){var p=wx.getStorageSync(n[m].groupid+a)||[],h=wx.getStorageSync("rendered_"+n[m].groupid+a)||[],d=h.concat(p);if(d.length){var f=d[d.length-1];f.unReadCount=p.length,f.unReadCount>99&&(f.unReadCount="99+");var v=f.time.split(" ")[0].split("-"),b=f.time.split(" ")[1].split(":"),N=v[2]<10?"0"+v[2]:v[2];f.time="".concat(v[1],"月").concat(v[2],"日 ").concat(b[0],"时").concat(b[1],"分"),f.dateTimeNum="".concat(v[1]).concat(N).concat(b[0]).concat(b[1]).concat(b[2]),f.groupName=n[m].groupname,t.push(f)}}return t.sort((function(t,e){return e.dateTimeNum-t.dateTimeNum})),console.log("array",t),t},openSearch:function(){this.setData({search_btn:!1,search_chats:!0,gotop:!0})},onSearch:function(t){var e=t.detail.value,a=this.getChatList(),n=[];a.forEach((function(t,a){-1!=String(t.username).indexOf(e)&&n.push(t)})),this.setData({arr:n})},cancel:function(){this.setData({search_btn:!0,search_chats:!1,arr:this.getChatList(),unReadSpotNum:getApp().globalData.unReadMessageNum>99?"99+":getApp().globalData.unReadMessageNum,gotop:!1})},clearInput:function(){this.setData({input_code:"",show_clear:!1})},onInput:function(t){var e=t.detail.value;e?this.setData({show_clear:!0}):this.setData({show_clear:!1})},tab_contacts:function(){wx.redirectTo({url:"../main/main?myName="+wx.getStorageSync("myUsername")})},close_mask:function(){this.setData({search_btn:!0,search_chats:!1,show_mask:!1})},tab_setting:function(){wx.redirectTo({url:"../setting/setting"})},tab_notification:function(){wx.redirectTo({url:"../notification/notification"})},into_chatRoom:function(t){var e=t.currentTarget.dataset.item;"groupchat"==e.chatType||"chatRoom"==e.chatType||e.groupName?this.into_groupChatRoom(e):this.into_singleChatRoom(e)},into_singleChatRoom:function(t){var e=wx.getStorageSync("myUsername"),a={myName:e,your:t.username};wx.navigateTo({url:"../chatroom/chatroom?username="+JSON.stringify(a)})},into_groupChatRoom:function(t){var e=wx.getStorageSync("myUsername"),a={myName:e,your:t.groupName,groupId:t.info.to};wx.navigateTo({url:"../groupChatRoom/groupChatRoom?username="+JSON.stringify(a)})},del_chat:function(t){var e,a=t.currentTarget.dataset.item;e="groupchat"==a.chatType||"chatRoom"==a.chatType?{your:a.info.to}:{your:a.username};var o=wx.getStorageSync("myUsername"),r=getCurrentPages();wx.showModal({title:"删除该聊天记录",confirmText:"删除",success:function(t){t.confirm&&(wx.setStorageSync(e.your+o,""),wx.setStorageSync("rendered_"+e.your+o,""),r[0]&&r[0].onShow(),n.fire("em.chat.session.remove"))},fail:function(t){}})}}};e.default=s},8164:function(t,e,a){"use strict";a.r(e);var n=a("254b"),o=a("fb4b");for(var r in o)"default"!==r&&function(t){a.d(e,t,(function(){return o[t]}))}(r);a("7c90");var s,u=a("f0c5"),i=Object(u["a"])(o["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],s);e["default"]=i.exports},"967a":function(t,e,a){},b949:function(t,e,a){"use strict";(function(t){a("93cd"),a("921b");n(a("66fd"));var e=n(a("8164"));function n(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,a("543d")["createPage"])},fb4b:function(t,e,a){"use strict";a.r(e);var n=a("80ca"),o=a.n(n);for(var r in n)"default"!==r&&function(t){a.d(e,t,(function(){return n[t]}))}(r);e["default"]=o.a}},[["b949","common/runtime","common/vendor"]]]);